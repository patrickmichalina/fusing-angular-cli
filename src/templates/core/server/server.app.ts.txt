import * as express from 'express'
import * as cookieParser from 'cookie-parser'
import { resolve } from 'path'
import { ngExpressEngine } from '@nguniversal/express-engine'
import { AppServerModule } from './server.angular.module'
import { stat, writeFile, createReadStream } from 'fs'

const environment = JSON.parse(process.env.FUSING_ANGULAR || '{}')
const isLocalDevelopmentServer = environment.name === 'DEVELOPMENT'

// const xhr2 = require('xhr2')

// tslint:disable-next-line:no-object-mutation
// xhr2.prototype._restrictedHeaders.cookie = false

const base = ''
const expressApp = express()
const dir = resolve(base, '.dist')
const publicDir = `${dir}/public`

isLocalDevelopmentServer && require('reload')(expressApp)

expressApp.use(cookieParser())

expressApp.set('x-powered-by', false)
expressApp.set('etag', false)
expressApp.set('view engine', 'html')

expressApp.engine('html', ngExpressEngine({ bootstrap: AppServerModule }))

expressApp.use('/favicon.ico', (req, res) => res.sendStatus(204)) // TODO: FAVICONS

function returnBrEncoding(availableEncodings: string[]) {
  return availableEncodings.some(a => a === 'br')
}

function returnGzipEncoding(availableEncodings: string[]) {
  return availableEncodings.some(a => a === 'gzip')
}

function writeJsHeaders(res: express.Response, contentLength: number, type: string) {
  res.writeHead(200, {
    "Content-Type": "application/javascript",
    "Content-Encoding": type,
    "Content-Length": contentLength
  });
}

function checkReturnJsFile(filePath: string, res: express.Response, encoding: string, append = true) {
  const path = append
    ? `${filePath}.${encoding}`
    : filePath
  stat(path, (err, stats) => {
    if (err) {
      res.writeHead(404)
      res.end()
    } else {
      writeJsHeaders(res, stats.size, encoding)
      createReadStream(path).pipe(res)
    }
  })
}

expressApp.get('/js**', (req, res) => {
  const encodings = (req.get('Accept-Encoding') || '').split(',').map(a => a.trim())
  const filePath = resolve(`${publicDir}${req.path}`)

  if (isLocalDevelopmentServer) {
    checkReturnJsFile(filePath, res, 'identity', false)
  } else if (returnBrEncoding(encodings)) {
    checkReturnJsFile(filePath, res, 'br')
  } else if (returnGzipEncoding(encodings)) {
    checkReturnJsFile(filePath, res, 'gzip')
  } else {
    checkReturnJsFile(filePath, res, 'identity', false)
  }
})

const virtualIndex = (req: express.Request,
  res: express.Response, document: string, path = `${publicDir}/index.html`) => {

  const resolvedPath = resolve(path)
  stat(resolvedPath, (err, stats) => {
    if (err) {
      writeFile(resolvedPath, '', err => {
        virtualIndex(req, res, document, path)
      })
    } else {
      res.render(resolvedPath, {
        req,
        res,
        document
      })
    }
  })
}

expressApp.get('**', (req, res) => {
  const document = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Fusing Angular</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <app-root></app-root>
    <script src="/js/vendor.js"></script>
    <script src="/js/app.js"></script>
    ${isLocalDevelopmentServer ? '<script src="/reload/reload.js"></script>' : ''}
  </body>
</html>`
  virtualIndex(req, res, document)
})

// app.use('/ngsw.json', express.static(`${dir}/ngsw.json`, staticOptions))
// app.use(
//   '/ngsw-worker.js',
//   express.static(`${dir}/ngsw-worker.js`, staticOptions)
// )
// app.use(
//   '/assets',
//   express.static(`${dir}/assets`, { ...staticOptions, fallthrough: false })
// )
// app.use(
//   '/manifest.json',
//   express.static(`${dir}/assets`, { ...staticOptions, fallthrough: false })
// )

// app.use('/robots.txt', express.static(`${dir}/web/robots.txt`, staticOptions))
// app.use('/ping.html', express.static(`${dir}/web/ping.html`, staticOptions))
// app.use(
//   '/favicon.ico',
//   express.static(`${dir}/assets/favicons/favicon-16x16.png`, {
//     ...staticOptions,
//     fallthrough: false
//   })
// )
// app.use(
//   '/assets/favicons/favicon.ico',
//   express.static(`${dir}/assets/favicons/favicon-16x16.png`, {
//     ...staticOptions,
//     fallthrough: false
//   })
// )

export { expressApp }